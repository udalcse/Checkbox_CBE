version: 1.0.{build}
branches:
  only:
  - feature/autoadd_recovery_services
environment:
  new_env_name: needs_to_be_set
  appveyor_env_key: needs_to_be_set
  admin_username: checkbox_admin
  admin_password: Ch3ckb0x_Adm!n
test: off
deploy_script:
- ps: "powershell -NonInteractive -command Disable-AzureDataCollection\nSet-StrictMode -Version Latest\n$ErrorActionPreference = \"Stop\"\n$PSDefaultParameterValues['*:ErrorAction']='Stop'\n\n$p=$pwd.Path\n$pw=ConvertTo-SecureString \"$env:admin_password\" -AsPlainText -Force\n\n$azureAccountName =\"a81c2e4f-7b07-461a-bdbb-65a53a5e8ba8\"\n$azurePassword = ConvertTo-SecureString \"TlMxXJDRXVxS5K23LzRx\" -AsPlainText -Force\n$psCred = New-Object System.Management.Automation.PSCredential($azureAccountName, $azurePassword)\n\n\n$fqdn = $env:fqdn\necho \"Setting hostname and domain for $fqdn\"\n$hostname = $fqdn.split(\".\")[0]\n$domain = $fqdn.Substring($fqdn.IndexOf(\".\") + 1)\n\necho \"Checking hostname $fqdn\"\n$headers = New-Object \"System.Collections.Generic.Dictionary[[String],[String]]\"\n$headers.Add(\"Authorization\",\"sso-key dL3rCCvfZY5s_3xPMgQLV8uw29Uxxkh5pWG:7VNTMBrNA91yp52qN5zPM7\")\n$headers.Add(\"Content-type\",\"application/json\")\n$r = Invoke-RestMethod -Uri https://api.godaddy.com/v1/domains/$domain/records/CNAME/$hostname -Headers $headers \n   \nif ( $r -and $r.PSobject.Properties.name -and $r.name) \n{\n    throw \"DNS entry $fqdn already exists\"\n}\n\necho \"Adding account\"\nAdd-AzureRmAccount -Credential $psCred -TenantId 6eb8aed8-3a80-435b-b838-af0140dddd0c -ServicePrincipal\n\necho \"Getting log\"\nGet-AzureRmLog -StartTime (Get-Date).AddMinutes(-10)\n\n#Write-Output $env\n#Write-Output $env:fqdn\n\n\n\n$headers = New-Object \"System.Collections.Generic.Dictionary[[String],[String]]\"\n$headers.Add(\"Authorization\",\"sso-key dL3rCCvfZY5s_3xPMgQLV8uw29Uxxkh5pWG:7VNTMBrNA91yp52qN5zPM7\")\n$headers.Add(\"Content-type\",\"application/json\")\n    \n$body = \" [{ `\"type`\": `\"CNAME`\",`\"name`\": `\"$hostname`\",`\"data`\": `\"$hostname.westus2.cloudapp.azure.com`\"}]\"\n     \nInvoke-RestMethod -Body $body -Headers $headers -Method Patch -Uri https://api.godaddy.com/v1/domains/$domain/records\n$native_call_success = $?\nif (-not $native_call_success)\n{\n    throw 'error setting up dns'\n}\n\necho \"Starting rollout\"\nWrite-Output \"creating resource group\" #  $env:new_env_name\"\n\nNew-AzureRmResourceGroup -Name \"$env:new_env_name\" -Location 'westus2'\n\necho deploying\nNew-AzureRmResourceGroupDeployment -Name \"$env:new_env_name\" -ResourceGroupName  \"$env:new_env_name\" -TemplateFile AzureAllInOneDeploy\\azuredeploy.json -uniqueEnvName \"$env:new_env_name\" -appveyerEnvKey $env:appveyor_env_key -adminPassword $pw -adminUsername \"$env:admin_username\" -fqdn \"$env:fqdn\""